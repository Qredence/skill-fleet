sequenceDiagram
    actor User
    participant CLI as CLI (Client)
    participant API as FastAPI /stream
    participant Service as ConversationService
    participant DSPy as DSPy Modules
    participant LLM as LLM (Gemini/DeepSeek)

    User->>CLI: "I want to create a skill for async testing"
    CLI->>API: POST /chat/stream {message, session_id}
    
    API->>Service: respond(message, session)
    
    rect rgb(240, 248, 255)
    Note over Service, LLM: Phase 1: Understanding
    Service->>DSPy: InterpretIntent(message)
    DSPy->>LLM: Analyze intent...
    LLM-->>DSPy: Intent: create_skill
    DSPy-->>Service: Result
    
    Service-->>API: Stream "thinking" event (Intent detected)
    API-->>CLI: Display thinking...
    
    Service->>DSPy: DeepUnderstanding(task)
    DSPy->>LLM: Generate clarifying questions...
    LLM-->>DSPy: Question + Reasoning
    DSPy-->>Service: Result
    end
    
    Service-->>API: Stream "response" event (Question)
    API-->>CLI: Render Question
    CLI-->>User: Display Question
    
    User->>CLI: "Yes, focused on pytest-asyncio"
    CLI->>API: POST /chat/stream {message, session_id}
    
    rect rgb(255, 240, 245)
    Note over Service, LLM: Phase 2: Confirmation & Creation
    Service->>DSPy: AssessReadiness()
    DSPy->>LLM: Score: 0.9 (Ready)
    Service->>DSPy: ConfirmUnderstanding()
    Service-->>API: Stream "response" (Confirmation Summary)
    end
    
    User->>CLI: "Yes, create it"
    CLI->>API: POST /chat/stream {message}
    
    rect rgb(240, 255, 240)
    Note over Service, LLM: Phase 3: Generation & TDD
    Service->>DSPy: SkillCreationProgram()
    Note right of Service: Executing Phase 1, 2, 3...
    Service->>DSPy: SuggestTests(skill_content)
    DSPy->>LLM: Generate Red/Green scenarios...
    Service-->>API: Stream "response" (TDD Checklist)
    end